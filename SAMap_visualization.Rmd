
# 1. Import and setup (run for all species)
```{r libraries, message=FALSE, warning=FALSE, paged.print=FALSE}
library(this.path)
setwd(this.dir())
library(dplyr)
library(stringr)
library(tibble)
library(cowplot)
library(Matrix)
library(Polychrome)
library(tidyr)
library(pheatmap)
library(paletteer)
library(Seurat)
library(SeuratData)
library(tidyseurat)
library(geiger)
library(SeuratDisk)
```

```{r import_data}

# load loss_gain table
  # columns: OGs
  # rows: node numbers
load("/Users/oliviatatro/Downloads/surf/orthodollo/loss_gain_pres_abs_H1.Rds")

# load og mapping files
  # columns: og and sc_ID
load("../single_cell/OG_maps.Rdata")
acropora_map <- read.table("../single_cell/acropora/acropora_map.tsv", sep = "\t")
nematostella_map <- read.table("../single_cell/nematostella/og_map.tsv")
xenia_map <- read.table("../single_cell/xenia/og_map.tsv")
rm(turritopsis_map, stylophora_map, clytia_map)

data <- Read10X(data.dir = "counts", gene.column = 1)

seurat <- CreateSeuratObject(counts = data)

barcodes <- read.table("counts/barcodes.tsv")
seurat$species <- barcodes$V8

umap <- read.table("counts/umap.tsv")
umap <- umap[colnames(seurat), ] # reorder to match seurat object

seurat[["umap"]] <- CreateDimReducObject(
  embeddings = as.matrix(umap),
  key = "UMAP_",
  assay = "RNA"
)

rm(barcodes, data)

DimPlot(seurat, reduction = "umap", group.by = "species") #+NoLegend()

aurelia_map$sc_ID <- paste0("aurelia-", aurelia_map$sc_ID)
acropora_map$sc_ID <- paste0("acropora-", acropora_map$sc_ID)
hydra_map$sc_ID <- paste0("hydra-", hydra_map$sc_ID)
nematostella_map$sc_ID <- paste0("nematostella-", nematostella_map$sc_ID)
xenia_map$sc_ID <- paste0("xenia-", xenia_map$sc_ID)

ogmap <- rbind(acropora_map, aurelia_map, hydra_map, nematostella_map, xenia_map)
rm(aurelia_map, acropora_map, hydra_map, nematostella_map, xenia_map)


```

```{r setup_focal_nodes}

# ----------------------- get gained ogs by node -----------------
# build focal_nodes df:
  # node: node number
  # name: abreviated node name (eg "anth")
  # ogs: list of ogs gained at node
if(file.exists("focal_nodes.Rds")) {
  readRDS("focal_nodes.Rds")
} else {
  focal_nodes <- data.frame(
    node = c(132, 133, 103, 104, 129, 
             130, 105, 116, 163, 159, 
             134, 137, 120, 108, 102, 
             150,   2,  22,  87,  88, 
             90,   74,  42,  11, 106,
             114, 117, 121, 122, 164, 
             166, 135, 136, 138, 139,
             140,  99, 100, 101),
    name = c("anth", "anth2", "endomed", "med", "endo", 
             "myx", "hyd", "acr", "oct", "cer", 
             "hex", "scler", "scyph", "siph", "cnid", 
             "act", "acropora", "nematostella", "hydra", "clytia",
             "turritopsis", "aurelia", "xenia", "stylophora", "106",
             "114", "117", "121", "122", "164", 
             "166", "135", "136", "138", "139",
             "140", "myr", "plan", "eum"),
    full_name = c("Anthozoa", "Ceriantheria + Hexacorallia", "Endocnidozoa + Medusozoa", "Medusozoa", "Endocnidozoa",
                  "Myxozoa", "Hydrozoa", "Acraspeda", "Octocorallia", "Ceriantheria", 
                  "Hexacorallia", "Scleractinia", "Scyphozoa", "Siphonophora", "Cnidaria",
                  "Actinaria", "Acropora", "Nematostella", "Hydra", "Clytia", 
                  "Turritopsis", "Aurelia", "Xenia", "Stylophora", "106",
                  "114", "117", "121", "122", "164", 
                  "166", "135", "136", "138", "139",
                  "140", "Myriazoa", "Planulozoa", "Eumetazoa")
    )
  print("Extracting OG gains for focal nodes from the orthodollo lossgain table...")
  focal_nodes$ogs <- lapply(focal_nodes$node, function(n){
    colnames(lossgain.table)[lossgain.table[n, ] == "g"]
  })
  
  saveRDS(focal_nodes, file = "focal_nodes.Rds")
}

rm(lossgain.table)

node_cols <- c("#E7468E", "#F63C35","#DA71FE", "#4991FE", "#8E10D2",
               "#590D8F",  "#2448D8", "#2ED9FF", "#AF0623", "",
               "#FA8018","#B1E923","#1FD295", "","#F4A7DE",
               "#F6E01A", "grey20", "grey20","grey20","grey20",
               "grey20","grey20","grey20","grey20", "grey20",
               "grey20","grey20","grey20","grey20", "grey20",
               "grey20","grey20","grey20","grey20", "grey20",
               "grey20", "grey20","grey20","grey20")
names(node_cols) <- focal_nodes$name

```

# 2. Feature plots

```{r feature_plot}
cell_types <- read.table("cell_types.tsv", header = TRUE)

unique(cell_types$cell_type)

cell_categories <- data.frame(old = unique(cell_types$cell_type), 
           new = c("Gland cell",        "Cnidocyte",         "Immune cell",    "Stem cell",    "Neuron", 
                   "Cnidoblast",        "Hair cell",         "Gastrodermis",   "Muscle",       "Mesoglea",
                   "Ectoderm",          "Neuron",            "Calicoblast",    "Ectoderm",     "Gastrodermis",
                   "Alga-hosting cell", "Progenitor",        "Gland cell",     "Cnidocyte",    "Digestive Filament",
                   "Immune cell",       "Ectoderm",          "Muscle",         "Immune cell",  "Epithelial Ectoderm",
                   "Cnidocyte",         "Ectoderm",          "Stem cell",      "Neuron",       "Cnidoblast",
                   "Gland cell",        "Muscle",            "Neuroglandular", "Germ cell",    "Stem cell",
                   "Head",              "Foot",              "Gland cell",     "Battery cell", "Stem cell",
                   "Basal disk",        "Tentacle",          "Neuroglandular", "Gland cell",   "Cnidocyte",
                   "Neuron",            "Germ cell",         "Stem cell",      "Ectoderm",     "Ectoderm",
                   "Neuron",            "Stem cell",         "Neuron",         "Muscle",         "Ectoderm",
                   "Stem cell",         "Alga-hosting cell", "Gland cell"))
cell_types <- merge(cell_types, cell_categories, by.x = "cell_type", by.y = "old") %>% 
  select(barcode, new) %>% 
  rename(cell_type = new)

cell_types <- cell_types %>% column_to_rownames("barcode")
seurat <- AddMetaData(seurat, metadata = cell_types)

colors <- c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3", "#FF7F00", 
            "#FFFF33", "#A65628", "#F781BF", "#6A3D9A", "#66C2A5",
            "#FC8D62", "#8DA0CB", "#A6D854", "#FFD92F", "#E5C494",
            "#B3B3B3", "#1B9E77", "#D95F02", "#7570B3", "#E7298A", 
            "#E6AB02", "#1F78B4", "maroon",  "black",
            "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#FDBF6F", 
            "#FF7F00", "#CAB2D6", "#FFFF99")

# plots just the nematostella cells with the more specific IDs 
pdf("umap_all.pdf", height = 10, width = 16)
DimPlot(seurat, reduction = "umap", group.by = "cell_type", cols = colors)
dev.off()


# removing cells that are far away from the main cluster
emb <- seurat@reductions$umap@cell.embeddings
cells_to_keep <- rownames(emb)[emb[, "UMAP_1"] > -2.5 & emb[, "UMAP_2"] < 0]
subset_seurat <- subset(seurat, cells = cells_to_keep)
cell_type_plot <- DimPlot(subset_seurat, reduction = "umap", group.by = "cell_type", cols = colors, pt.size = 1.2) +
  guides(color = guide_legend(ncol = 1, override.aes = list(size = 3))) +
  theme(plot.title = element_blank())
pdf("cell_type_umap.pdf", height = 10, width = 16)
print(cell_type_plot)
dev.off()

med_subset <- subset(subset_seurat, species %in% c("aurelia", "hydra"))
#pdf("umap.pdf", height = 10, width = 16)
DimPlot(med_subset, reduction = "umap", group.by = "cell_type", cols = colors)
#dev.off()

#anth_subset <- subset(subset_seurat, species %in% c("xenia", "nematostella", "acropora"))
#pdf("umap.pdf", height = 10, width = 16)
#DimPlot(anth_subset, reduction = "umap", group.by = "cell_type", cols = colors)
#dev.off()
```

```{r feature_plot_split}

dir.create("figures")

nodes = c("cnid", "endomed", "med", "acr", "anth", "oct", "act", "scler", "hyd", "scyph")

species_list <- SplitObject(seurat, split.by = "species")

for (sp in names(species_list)){
  obj <- species_list[[sp]]
  obj <- NormalizeData(obj, normalization.method = "LogNormalize")
  
  for (node in nodes) {
    module_name = paste0("Module_", sp, "_", node, "_")
    ogs_gained <- focal_nodes[focal_nodes$name == node,]$ogs
    genes_gained <- filter(ogmap, og %in% unlist(ogs_gained))
    
    # if there are no gains in a node, make the module score all NA
    if (nrow(filter(genes_gained, grepl(sp, sc_ID))) == 0) {
      print(paste(sp, "did not have gains in", node))
      obj[[paste0(module_name,1)]] <- NA
    } else {
      genes_gained <- genes_gained$sc_ID
      gene_gain_filtered <- intersect(genes_gained, rownames(obj))
      
      obj <- AddModuleScore(
          obj,
          features = list(gene_gain_filtered),
          name = module_name
      )
      
      print(FeaturePlot(obj, features = paste0(module_name, "1"), reduction = "umap") +
        scale_colour_gradientn(colors = c("yellow", "deeppink1", "blue")) +
        theme(plot.background = element_rect(color = node_cols[node], fill = NA, size = 3)) +
        ggtitle(NULL))
      
    }
    
  }
  species_list[[sp]] <- obj
}

cnid_scored <- merge(
    species_list[[1]],
    y = species_list[2:length(species_list)]
)

cnid_scored[["umap"]] <- CreateDimReducObject(
  embeddings = as.matrix(umap),
  key = "UMAP_",
  assay = "RNA"
)

# get minimum and maximum module scores from all columns 
module_cols <- grep("^Module_", colnames(cnid_scored@meta.data), value = TRUE)
mins <- numeric()
maxs <- numeric()
for (module in module_cols) {
  if(!all(is.na(cnid_scored[[module]][,1]))) {
    mins <- c(mins, min(cnid_scored[[module]][,1], na.rm = TRUE))
    maxs <- c(maxs, max(cnid_scored[[module]][,1], na.rm = TRUE))
  }
}
min_mod_score <- min(mins)
max_mod_score <- max(maxs)

plots <- list()

for (node in nodes) {
  # unify module score into one column
  cnid_scored$node_gain_score <- NA
  
  for (sp in unique(cnid_scored$species)) {
      colname <- paste0("Module_", sp, "_", node, "_1")
      idx <- cnid_scored$species == sp
      cnid_scored$node_gain_score[idx] <- cnid_scored[[colname]][,1][idx]
  }
  
  emb <- cnid_scored@reductions$umap@cell.embeddings
  cells_to_keep <- rownames(emb)[emb[, "UMAP_1"] > -2.5 & emb[, "UMAP_2"] < 0]
  cnid_subset <- subset(cnid_scored, cells = cells_to_keep)
  
  na_cells <- colnames(cnid_subset)[is.na(cnid_subset[["node_gain_score"]][,1])]
  non_na_cells <- colnames(cnid_subset)[!is.na(cnid_subset[["node_gain_score"]][,1])]
  # shuffle order so it looks less blocky
  non_na_cells <- sample(non_na_cells, length(non_na_cells), replace = FALSE)
  
  feature_plot <- 
    FeaturePlot(cnid_subset, features = "node_gain_score", reduction = "umap", cells = c(na_cells, non_na_cells)) + 
    scale_colour_gradientn(colors = c("yellow", "#ff57c7", "blue")) + #, limits = c(min_mod_score, max_mod_score) c("yellow", "#ff57c7", "blue")
    theme(plot.background = element_rect(color = node_cols[node], fill = NA, size = 3)) +
    ggtitle(NULL) 
  
  feature_plot <- feature_plot + coord_cartesian(clip = "off") +
    annotate("label", x = Inf, y = Inf, label = focal_nodes$full_name[focal_nodes$name == node], fill = "white", color = node_cols[node], size = 5, hjust = 1)
  
  plots[[node]] <- feature_plot
  
  #pdf(paste0("figures/", node, "_umap.pdf"), width = 8, height = 8)
  #print(feature_plot) 
  #dev.off()
}
blank_plot <- ggplot() + theme_void()
q1 <- cell_type_plot
q2 <- cowplot::plot_grid(plotlist = plots[1:4], nrow = 2, ncol = 2)
q3 <- cowplot::plot_grid(plotlist = plots[5:8], nrow = 2, ncol = 2)
q4 <- cowplot::plot_grid(plotlist = c(plots[9:10], blank_plot, blank_plot), nrow = 2, ncol = 2)

samap_fig <- cowplot::plot_grid(q1, q2, q3, q4, nrow = 2, ncol = 2)

#pdf("figures/samap_exp.pdf", height = 20, width = 20)
print(samap_fig)
ggsave("figures/samap_exp.png", width = 25, height = 25)
#dev.off()
```
